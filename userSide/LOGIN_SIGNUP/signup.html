<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sign Up with Face Capture</title>
  <link rel="stylesheet" href="../styles.css">
</head>
<body class="signup">

  <div class="signup-box">
    <h2>SIGN UP</h2>
    <form id="signupForm">
      <input type="text" id="fullName" placeholder="Full Name" required>
      <input type="email" id="email" placeholder="Email" required>
      <input type="text" id="username" placeholder="Username" required>
      <input type="password" id="password" placeholder="Password" required>
      <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
      <div id="passwordMsg" class="error"></div>

      <video id="video" autoplay muted></video>
      <img id="capturedImage" src="" alt="Captured face preview">
      <input type="hidden" id="faceImage" name="faceImage">

      <div class="button-group">
        <button type="button" id="captureBtn">Capture Face</button>
        <button type="submit" id="signupBtn">Create Account</button>
        <a href="../LOGIN_SIGNUP/user_login.html" class="login-link">Already have an account? Log in here</a>
      </div>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    async function loadFirebase() {
      const configUrl = new URL('../../PHP/firebase_config.php', import.meta.url);
      const response = await fetch(configUrl, { credentials: 'same-origin' });
      if (!response.ok) {
        throw new Error(`Unable to load Firebase configuration: ${response.status}`);
      }
      const app = initializeApp(await response.json());
      const auth = getAuth(app);

      window.auth = auth;
      window.getAuth = getAuth;
      onAuthStateChanged(auth, user => {
        if (user) {
          console.log('Logged in as:', user.email);
        } else {
          console.log('Not logged in');
        }
      });

      const video = document.getElementById('video');
      const captureBtn = document.getElementById('captureBtn');
      const faceInput = document.getElementById('faceImage');
      const capturedImage = document.getElementById('capturedImage');
      const password = document.getElementById('password');
      const confirmPassword = document.getElementById('confirmPassword');
      const passwordMsg = document.getElementById('passwordMsg');

      // Webcam
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          video.srcObject = stream;
        })
        .catch(err => {
          alert("Camera access denied: " + err);
        });

      // Capture face image
      captureBtn.addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL('image/png');
        faceInput.value = imageData;
        capturedImage.src = imageData;
        capturedImage.style.display = 'block';
        video.style.display = 'none';
        captureBtn.textContent = "Face Captured âœ…";
        captureBtn.disabled = true;
      });

      function isStrongPassword(pw) {
        const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
        return regex.test(pw);
      }

      // Form submission
      document.getElementById('signupForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const fullName = document.getElementById('fullName').value;
        const email = document.getElementById('email').value;
        const username = document.getElementById('username').value;
        const pw = password.value;
        const confirmPw = confirmPassword.value;
        const faceImage = faceInput.value;

        if (!isStrongPassword(pw)) {
          passwordMsg.textContent = "Password must be 8+ chars with uppercase, lowercase, number, and symbol.";
          return;
        }

        if (pw !== confirmPw) {
          passwordMsg.textContent = "Passwords do not match.";
          return;
        }

        if (!faceImage) {
          alert("Please capture your face before signing up.");
          return;
        }

        try {
          await createUserWithEmailAndPassword(auth, email, pw);
          const res = await fetch('../../PHP/register_user.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fullName, email, password: pw, faceImage })
          });
          const data = await res.json();
          if (!res.ok || !data.success) {
            throw new Error(data.error || 'Failed to save user');
          }
          passwordMsg.textContent = "";
          alert("Signup successful! Redirecting to login page...");
          window.location.href = "../LOGIN_SIGNUP/user_login.html";
        } catch (err) {
          alert(err.message);
        }
      });
    }

    loadFirebase().catch(err => console.error('Firebase init failed:', err));
  </script>

</body>
</html>
