<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Order Details - Cindy's Bakeshop</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body class="invoice-page">

<div class="invoice-container" id="invoice">
  <h1>Order Invoice</h1>
  <div class="invoice-header">
    <div><b>Name:</b> <span id="name"></span></div>
    <div><b>Address:</b> <span id="address"></span></div>
    <div><b>Payment Method:</b> <span id="mop"></span></div>
    <div><b>Order Date:</b> <span id="date"></span></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Item</th>
        <th>Subtotal</th>
      </tr>
    </thead>
    <tbody id="items-list"></tbody>
  </table>

  <div class="total">Total: ₱<span id="total"></span></div>

  <a class="back-btn" href="../PRODUCT/MENU.html">← Back to Home</a>
  <button id="download-btn" class="back-btn">⬇ Download PDF</button>
</div>

<!-- Include html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
  const params = new URLSearchParams(window.location.search);
  const orderId = params.get('order_id');
  if (orderId) {
    fetch('../../PHP/order_api.php?action=view&order_id=' + orderId)
      .then(res => res.json())
      .then(data => {
        if (!data.order) {
          document.querySelector('.invoice-container').innerHTML = '<h2>No Order Found</h2>';
          return;
        }
        const order = data.order;
        const user = data.user || {};
        const transaction = data.transaction || {};
        document.getElementById('name').textContent = user.Name || '';
        document.getElementById('address').textContent = user.Address || '';
        document.getElementById('mop').textContent = transaction.Payment_Method || '';
        document.getElementById('date').textContent = order.Order_Date;

        const tbody = document.getElementById('items-list');
        let total = 0;
        data.items.forEach(item => {
          total += parseFloat(item.Subtotal);
          const row = document.createElement('tr');
          row.innerHTML = `<td>${item.Name} x${item.Quantity}</td><td>₱${parseFloat(item.Subtotal).toFixed(2)}</td>`;
          tbody.appendChild(row);
        });
        document.getElementById('total').textContent = total.toFixed(2);
      });
  } else {
    document.querySelector('.invoice-container').innerHTML = '<h2>No Order Found</h2>';
  }

  document.getElementById("download-btn").addEventListener("click", function () {
    const element = document.getElementById("invoice");
    const opt = {
      margin: 0.5,
      filename: 'CindysBakeshop_Invoice.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
  });
</script>
  <script type="module" src="../firebase-init.js"></script>
</body>
</html>
